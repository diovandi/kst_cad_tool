# Generic Input File Format (KST Analysis and Optimization)

This document defines a **generic**, declarative input format for the KST analysis script. It is intended to be generated by the CAD add-in wizard and consumed by a generic MATLAB (or compiled) pipeline, so that any geometry and constraint set can be analyzed without case-specific `.m` files.

---

## 1. Analysis Input File (constraint set only)

One-time analysis: define the constraint set; the script computes WTR, MTR, TOR, RI.

### 1.1 JSON schema (analysis)

| Field | Type | Description |
|-------|------|-------------|
| `version` | integer | Format version (1) |
| `point_contacts` | array of [6] | Each row: `[x, y, z, nx, ny, nz]` — position and unit normal (CP) |
| `pins` | array of [6] | Each row: `[x, y, z, ax, ay, az]` — center and unit axis (CPIN) |
| `lines` | array of [10] | Each row: `[mx, my, mz, lx, ly, lz, nx, ny, nz, length]` — midpoint, line dir, constraint normal, length (CLIN) |
| `planes` | array of object | Each: `{ "midpoint": [x,y,z], "normal": [nx,ny,nz], "type": 1|2, "prop": [...] }` — type 1=rect, 2=circ; prop per thesis (CPLN) |

All coordinates and vectors are in the same global coordinate system (e.g. part or assembly CS).

### 1.2 Example (analysis only)

See [../matlab_script/Input_files/generic_example_analysis.json](../matlab_script/Input_files/generic_example_analysis.json) for a minimal point-contact-only example equivalent to a subset of Thompson's chair.

### 1.3 Mapping to legacy MATLAB variables

- `point_contacts` → `cp` (matrix, one row per CP)
- `pins` → `cpin`
- `lines` → `clin`
- `planes` → `cpln` and `cpln_prop`
- No `grp_members` / `grp_rev_type` / `grp_srch_spc` in analysis-only input.

---

## 2. Optimization Input File (constraint set + optimization plan)

Used when running **constraint revision** (search over location/orientation of selected constraints). The wizard produces:

1. **Baseline constraint set** (same as analysis input).
2. **Optimization plan:** which constraint(s) to vary, search space type, and the **candidate matrix** (discretized positions/orientations).

### 2.1 Search space types (per constraint or group)

| Type | Name | Description | Parameters (example) |
|------|------|-------------|----------------------|
| `discrete` | Discrete | Finite set of candidate points/orientations | List of candidates: each `[Px, Py, Pz, Nx, Ny, Nz]` for CP |
| `line` | Line search | Move along a line | `origin [3]`, `direction [3]`, `num_steps`, optional `length` or `limits` |
| `curve_line` | Curve-line | Search along a curve | (Future; not in initial scope) |
| `plane` | Plane search | Grid on a plane | `origin`, `u_dir`, `v_dir`, `num_u`, `num_v` |
| `orient_1d` | Orientation 1D | Rotate normal about one axis | `axis [3]`, `angle_deg` or `num_steps`, `angle_min`, `angle_max` |
| `orient_2d` | Orientation 2D | Two rotation angles | `axis1`, `axis2`, `angle1`, `angle2` (ranges or steps) |
| `line_orient` | Line orientation | Orientation search for line constraint | (Per thesis) |
| `resize_line` | Resize line | Vary line length | `length_min`, `length_max`, `num_steps` |
| `resize_rect_plane` | Resize rect plane | (Future) | |
| `resize_circ_plane` | Resize circ plane | (Future) | |

Numeric codes used in legacy MATLAB `grp_rev_type`: 1=none, 2=line_move, 3=curved_move, 4=plane_move, 5=orient1d, 6=orient2d, 7=line_orient, 8=resize_line, 9=resize_rect_plane, 10=resize_circ_plane.

### 2.2 Optimization plan structure (JSON)

| Field | Type | Description |
|-------|------|-------------|
| `version` | integer | 1 |
| `analysis_input` | object | Full analysis input (constraint set) as in §1 |
| `optimization` | object | |
| `optimization.modified_constraints` | array | Each element: `{ "type": "point"|"pin"|"line"|"plane", "index": 1-based, "search_space": { ... } }` |
| `optimization.search_space` (per constraint) | object | `"discrete"` → `"candidates": [ [Px,Py,Pz,Nx,Ny,Nz], ... ]`; `"line"` → `"origin", "direction", "num_steps"`; `"orient_1d"` → `"axis", "angle_min", "angle_max", "num_steps"`; etc. |
| `optimization.candidate_matrix` | array of object | Optional precomputed matrix: `{ "constraint_index": 1, "candidates": [ [6 values], ... ] }` — wizard can output this so the script does not need to discretize |

The script uses this to:

1. Identify the **base motion set** (all motions that do **not** involve the modified constraint indices).
2. For each candidate in the candidate matrix, build the modified constraint set and run analysis **only** for motion combinations that involve the modified constraint(s).

### 2.3 Example (optimization)

See [../matlab_script/Input_files/generic_example_optimization.json](../matlab_script/Input_files/generic_example_optimization.json) for a single-constraint (CP6) line search with 5 steps.

---

## 3. Candidate matrix (whiteboard “CP6.1 … CP6.5”)

The **candidate matrix** is the result of the wizard’s discretization:

- **Rows:** candidates (e.g. CP6.1, CP6.2, …, CP6.N).
- **Columns (for point contact):** Px, Py, Pz, Nx, Ny, Nz.

The add-in (or a separate preprocessor) is responsible for producing these coordinates from the user’s choices (line direction, number of steps, etc.). The MATLAB script then:

- Takes the baseline input file.
- For each candidate row, replaces the selected constraint with that row’s [Px,Py,Pz,Nx,Ny,Nz].
- Identifies which motion sets involve that constraint; recomputes only those (base motion set unchanged).
- Aggregates results (WTR, MTR, TOR per candidate).

---

## 4. File locations and usage

- **Analysis-only:** `generic_example_analysis.json` — load in MATLAB, convert to `cp`/`cpin`/etc., run `main_loop` + rating (no optimization).
- **Optimization:** `generic_example_optimization.json` — load, apply optimization plan and candidate matrix, run revision loop with base-motion-set isolation.

A MATLAB helper (e.g. `load_generic_input.m`) can read these JSON files and populate the global variables expected by the existing analysis/optimization code; see [../matlab_script/Analysis and design tool/load_generic_input.m](../matlab_script/Analysis%20and%20design%20tool/load_generic_input.m) when implemented.
